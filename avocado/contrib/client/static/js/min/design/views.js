require.def('design/views',['design/chart','design/form'],function(chart,form){var manager=function($container,$titleBar,$tabsBar,$contentBox,$addQueryBox){var binaryFieldRe=/^(\d*)_(\d*)_input([01])$/;var fieldRe=/^(\d*)_(\d*)$/;var opRe=/^(\d*)_(\d*)_operator$/;var cache={};var tab_tmpl='<a class="tab" href="#"><%= this.tabname %></a> ';var add_query_tmpl='<input id="add_to_query" type="button" value="Add To Query"/>';var activeConcept=null;var activeView=null;function builtinViewCreator(view){var result=$('<div class="view"></div>');
$.each(view.elements,function(index,element){switch(element.type){case'form':result.append(form.Form(element,view.concept_id));break;case'chart':var datatype=element.data.datatype;var location=undefined;if(datatype==='decimal'){result.append(chart.getLineChart(element,view.concept_id,location));}else if(datatype==='choice'){var len=element.data.coords.length;if(len<=3){result.append(chart.getPieChart(element,view.concept_id,location));}else{result.append(chart.getBarChart(element,view.concept_id,location));}}
break;default:result.append($('<p>Undefined View!</p>'));}});result.children().trigger('UpdateDSEvent',[cache[activeConcept].ds]);$container.trigger('ViewReadyEvent',[result]);};function viewReadyHandler(evt,$view){activeView.contents=$view;if($view.parent().length===0){$contentBox.append($view);}
activeView.contents.css("display","block");$(".chart",activeView.contents).css("display","block");$view.children().trigger("GainedFocusEvent");activeView.loaded=true;};function showViewHandler(evt,tabIndex){if(activeView!==null){activeView.contents.css("display","none");activeView.contents.children().trigger("LostFocusEvent");if($("shape",activeView.contents).length===0){activeView.contents.detach();}}
activeView=cache[activeConcept].views[tabIndex];if(activeView.loaded){viewReadyHandler(null,activeView.contents);}else{var callback=null;activeView.concept_id=activeConcept;if(activeView.type!=='custom')
callback=builtinViewCreator;loadDependencies(activeView,callback);}};function updateQueryHandler(evt,query){console.log(query);var concept=cache[activeConcept];};function viewErrorHandler(evt,details){};function elementChangedHandler(evt,element){cache[activeConcept].ds[element.name]=element.value;$.each(cache[activeConcept].views,function(index,view){if(activeView!==view&&view.contents){view.contents.children().trigger("UpdateElementEvent",[element]);}});};function createAndSendQueryDataStructure(event){var ds=cache[activeConcept].ds;var fields={};for(var item in ds){if(!ds.hasOwnProperty(item))continue;var m=fieldRe.exec(item);if(m){fields[m[2]]={val0:ds[item],val1:null,op:null};continue;}
m=binaryFieldRe.exec(item);if(m){if(fields.hasOwnProperty(m[2])){fields[m[2]]['val'+m[3]]=ds[item];}else{fields[m[2]]={val0:null,val1:null,op:null};fields[m[2]]['val'+m[3]]=ds[item];}}}
for(item in ds){if(!ds.hasOwnProperty(item))continue;m=opRe.exec(item);if(m){fields[m[2]]['op']=ds[item];}}
var nodes=[];for(var field_id in fields){var field=fields[field_id];if(field.val0&&field.val1&&field.op){nodes.push({'type':'field','operator':field.op,'id':field_id,'value':[field.val0,field.val1]});}else if(field.val0&&field.op&&!(field.val0 instanceof Array)){nodes.push({'type':'field','operator':field.op,'id':field_id,'value':field.val0});}else if(field.val0&&field.val0 instanceof Array){field.op=field.op!==null?field.op:"in";nodes.push({'type':'field','operator':field.op,'id':field_id,'value':field.val0});}else if(field.val0!==null&&!(field.val0 instanceof Array)&&field.op===null&&field.val1===null){nodes.push({'type':'field','operator':"exact",'id':field_id,'value':field.val0});}else{throw"Unable to determine field "+field+" in concept "+cache[activeConcept];}}
var server_query;if(nodes.length===1){server_query=nodes;}else{server_query=[{'type':'logic','operator':'and','children':nodes}];}
$(event.target).trigger("UpdateQueryEvent",[server_query]);}
$container.bind({'ViewReadyEvent':viewReadyHandler,'UpdateQueryEvent':updateQueryHandler,'ViewErrorEvent':viewErrorHandler,'ShowViewEvent':showViewHandler,'ElementChangedEvent':elementChangedHandler,'UpdateQueryButtonClicked':createAndSendQueryDataStructure});function loadDependencies(deps,cb){cb=cb||function(){};if(deps.css)
LazyLoad.css(deps.css);if(deps.js){LazyLoad.js(deps.js,function(){cb(deps);});}else{cb(deps);}};function loadConcept(concept){register(concept);activeConcept=concept.pk;concept.globalsLoaded=true;if(concept.views.length<2){$tabsBar.css('display','none');$container.find('.content').removeClass('content').attr('id','removedContent');}else{$tabsBar.css('display','block');$container.find('#removedContent').addClass('content');}
var tabs=$.jqote(tab_tmpl,concept.views);$tabsBar.html(tabs);$tabsBar.children(':first').click();var builtin=true;$.each(concept.views,function(index,element){if(element.type!=="builtin"){builtin=false;}});if(builtin){$addQueryBox.show();}else{$addQueryBox.hide();}};function tabClickedHandler(evt,tab){var index=$tabsBar.children().index(tab);$tabsBar.trigger('ShowViewEvent',index);};$tabsBar.bind('ConceptTabClickedEvent',tabClickedHandler);$tabsBar.tabs(true,function(evt,$tab){$tab.trigger('ConceptTabClickedEvent',$tab);});$addQueryBox.hide();var $addQueryButton=$('<input id="add_to_query" type="button" value="Add To Query"/>');$addQueryButton.click(function(){var event=$.Event("UpdateQueryButtonClicked");event.target=this;$(this).trigger(event);});$addQueryBox.append($addQueryButton);function register(concept){if(cache[concept.pk]===undefined)
cache[concept.pk]=concept;if(!concept.ds){concept.ds={};}};function show(concept,index,target){if(concept.pk===activeConcept)
return;$titleBar.text(concept.name);if(cache[concept.pk]&&cache[concept.pk].globalsLoaded){loadConcept(concept);}else{loadDependencies(concept,loadConcept);}};return{register:register,show:show};};return{manager:manager};});